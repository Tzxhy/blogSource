---
title: 代码中时间的概念
date: 2019-03-29 05:39:08
tags:
categories:
- 前端杂谈
---
## 话说
话说我一个前端，为啥要跟时间扯上关系？PS：本来我开始的标题是 JS 中的时间，但一想，貌似跟开发语言没关系啊！确实没关系，我们开始正题。

## 引入
问题的开始，是运行了一个云函数（位于 FaaS 架构的微服务），在其中运行了类似如下代码：
```ts
// ...
const [hours, minutes]: number[] = USER_INPUT_VALUE;
const newDate: number = new Date().setHours(hours, minutes);
db.add({
    date: newDate,
    openId,
    // ...
});
FrontEnd.send({
    newDate, // 将时间戳回传给前端
});
// ...
```
大致意思是，用户给个时、分的值，服务端构造一个时间戳，存入数据库，回送前端。好了，发现问题没？

<!-- more -->
起初我也是黑人问号脸，没问题啊！

___
直到我发起了一个请求：21:05叫我睡觉。（PS: 假设当时是21:00）

### 正确的表现是什么？
按需求来说，数据库中插入的时间应该是21:05:00.000 GMT +0800，但实际上的时间是21:05:00.000Z。

### What's wrong?
明眼的同学，可能一下就看出来了，可能是 **时区** 的问题（我比较近视，看了好久、调试了好久才发现）。我当时也不太明白时区的概念，顺便学习了一波 ES5的 Date 相关定义，也了解了一些额外的名词。下面一一解答。

### Date.now()
[文档在这里](http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.4.4)。这是 esma script5的英文原版文档。
> now 函数返回一个数字值，该值表示了调用该函数时到 UTC 的时间。

什么是 UTC?
### UTC
来一篇 [维基百科](https://en.wikipedia.org/wiki/Coordinated_Universal_Time) 。大家可看可不看，都是 English。我简单说说，以我们需要理解的为主：
1. UTC 翻译过来，世界协调时。是由世界时钟（某个组织）主要推荐的时间标准；
2. GMT，格林威治时间，早于 UTC 300年左右；
3. UTC 等于 GMT

就只需要知道这些了。
### GMT
GMT，就是现在（now）距离1970/1/1 00:00的格林威治的时间。为什么要加上个地点呢？这我就不找什么权威文献了，就从基本认知来说（嫌无聊可以跳过这一节）：
1. 地球自转
2. 不同的地方，早上太阳照射的顺序不同；
3. 人为规定，某些经度范围内为一个时区（比如美国自己分了多个时区，中国统一一个时区）
4. 所以，在某一个绝对时刻：中国东八区是3月1日20:00，美国的西八区就是3月1日04:00
5. 在4的基础上
    - 中国东八区时间表示为：Thu Mar 01 2018 20:00:00 GMT+0800 (中国标准时间)
    - 西八区时间：Thu Mar 01 2018 04:00:00 GMT-0800 (北美太平洋标准时间)
    - 但是 date.getTime() 返回的值都是1519905600000。说明该值是全世界统一的（某一绝对时间、同时满足其他绝对条件）

这一部分不理解的话，多看几遍，然后在电脑上试一下：改一下系统的所在时区，看看输出有什么不同。

## 第一次总结
发现了问题：我们中国是东八区，也就是 GMT+0800，服务器是GMT+0000时区。在不同时区『任意』操作时间，就可能产生问题。

## 递进
查看一下 Date.prototype.serHours(hour[, min[, sec[,ms]]])，[文档](http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.5.34)
还是我简单先说说：
1. 获取当地时间；
2. 以当前时区设置时分秒毫秒；
3. 返回时间戳。

所以，出现了之前的 case：用户在东八区设置了一个时间，比如是东八区的20:00，结果在数据库中变成了0区(js 中表现为 Z )的20:00，当然时间就不一样了。


## fix
问题的核心已经明确，就是以时区为基础，将所有时间的操作都在该时区上操作，而不是 Node.js 中默认的系统时区。这样就能解决问题。

使用了 **moment-timezone** 这个库来设置默认时区：
```js
const moment = require('moment-timezone');
// 设置时区为上海，使入库、前端显示的时间都是 GMT+0800
moment.tz.setDefault('Asia/Shanghai');
// 后续的都是用 moment 获取、设置时间即可
```

# 总结
虽然是一个小 API，但涉及到了国际化。好好学习，天天向上。
